{% extends "base.html" %}

{% block title %}Usuarios{% endblock %}
{% block body_class %}dash-page{% endblock %}

{% block content %}
<div class="dash-layout">
  <aside class="dash-sidebar">
    <div class="dash-sidebar-header">
      <a href="/dashboard" class="dash-logo-link">
        <div class="dash-logo">
          <img src="/static/images/logo.png" alt="CyberWatch Logo" class="dash-logo-img" onerror="this.style.display='none'">
        </div>
        <div class="dash-brand">
          <span class="dash-brand-title">CyberWatch</span>
          <span class="dash-brand-subtitle">SOC Console</span>
        </div>
      </a>
    </div>

    <nav class="dash-nav">
      <a href="/dashboard" class="dash-nav-item">
        <span class="dash-nav-dot"></span>
        <span>Dashboard</span>
      </a>
      <a href="/incidents" class="dash-nav-item">
        <span class="dash-nav-dot"></span>
        <span>Incidentes</span>
      </a>
      <a href="/users" class="dash-nav-item dash-nav-item-active">
        <span class="dash-nav-dot"></span>
        <span>Usuarios</span>
      </a>
    </nav>

    <div class="dash-sidebar-footer">
      <div class="dash-user">
        <div class="dash-user-avatar">{{ user.full_name[0]|upper }}</div>
        <div class="dash-user-meta">
          <span class="dash-user-name">{{ user.full_name }}</span>
          <span class="dash-user-email">{{ user.email }}</span>
        </div>
      </div>
      <a href="/logout" class="dash-logout-link">Cerrar sesión</a>
    </div>
  </aside>

  <main class="dash-main">
    <header class="dash-header">
      <div>
        <h1 class="dash-title">Usuarios</h1>
        <p class="dash-subtitle">Gestión de usuarios del sistema</p>
      </div>
      {% if user.role == 'admin' %}
      <a href="/users/new" class="dash-btn-create">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Crear usuario
      </a>
      {% endif %}
    </header>

    <section class="dash-panels">
      <div class="dash-panel">
        <div class="dash-panel-header">
          <h2 class="dash-panel-title">Listado de usuarios</h2>
          <span class="dash-panel-subtitle">{{ users|length }} usuarios registrados</span>
        </div>
        
        <div class="dash-table-wrapper">
          <table class="dash-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre completo</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Estado</th>
                {% if user.role == 'admin' %}
                <th>Acciones</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% if users %}
              {% for usr in users %}
              <tr>
                <td>{{ usr.id }}</td>
                <td class="dash-col-title">{{ usr.full_name }}</td>
                <td>{{ usr.email }}</td>
                <td>
                  <span class="dash-badge {% if usr.role == 'admin' %}dash-badge-critico{% else %}dash-badge-medio{% endif %}">
                    {% if usr.role == 'admin' %}Administrador{% else %}Analista{% endif %}
                  </span>
                </td>
                <td>
                  {% if usr.is_active %}
                  <span class="dash-badge dash-badge-bajo">Activo</span>
                  {% else %}
                  <span class="dash-badge">Inactivo</span>
                  {% endif %}
                </td>
                {% if user.role == 'admin' %}
                <td>
                  <div style="display: flex; gap: 8px;">
                    <a href="/users/{{ usr.id }}/edit" class="dash-link" title="Editar usuario">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </a>
                    {% if usr.id != user.id %}
                    <button type="button" onclick="showDeleteUserModal({{ usr.id }}, '{{ usr.full_name }}', '{{ usr.email }}')" style="background: none; border: none; cursor: pointer; color: #f87171; padding: 0;" title="Eliminar usuario">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>
                    {% endif %}
                  </div>
                </td>
                {% endif %}
              </tr>
              {% endfor %}
              {% else %}
              <tr>
                <td colspan="{% if user.role == 'admin' %}6{% else %}5{% endif %}" class="dash-table-empty">
                  No hay usuarios registrados todavía.
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Modal de confirmación de eliminación de usuario -->
<div id="deleteUserModal" class="modal-overlay" style="display: none;">
  <div class="modal-container">
    <div class="modal-header">
      <div class="modal-icon modal-icon-danger">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 9V13M12 17H12.01M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h3 class="modal-title">Eliminar usuario</h3>
      <p class="modal-subtitle">Esta acción no se puede deshacer</p>
    </div>
    
    <div class="modal-body">
      <p class="modal-text">
        ¿Estás seguro de que deseas eliminar al usuario
        <strong id="deleteUserName"></strong>?
      </p>
      <div class="modal-warning">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M8 5V9M8 11H8.01M14 8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8C2 4.68629 4.68629 2 8 2C11.3137 2 14 4.68629 14 8Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Se perderá el acceso de <strong id="deleteUserEmail"></strong> al sistema</span>
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn-secondary" onclick="closeDeleteUserModal()">Cancelar</button>
      <form method="post" action="" id="deleteUserForm" style="display: inline;">
        <button type="submit" class="btn-danger">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M3 4H13M5 4V3C5 2.44772 5.44772 2 6 2H10C10.5523 2 11 2.44772 11 3V4M6.5 7.5V11.5M9.5 7.5V11.5M4 4H12V13C12 13.5523 11.5523 14 11 14H5C4.44772 14 4 13.5523 4 13V4Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Sí, eliminar
        </button>
      </form>
    </div>
  </div>
</div>

<script>
function showDeleteUserModal(userId, userName, userEmail) {
  document.getElementById('deleteUserName').textContent = userName;
  document.getElementById('deleteUserEmail').textContent = userEmail;
  document.getElementById('deleteUserForm').action = '/users/' + userId + '/delete';
  document.getElementById('deleteUserModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeDeleteUserModal() {
  document.getElementById('deleteUserModal').style.display = 'none';
  document.body.style.overflow = '';
}

// Cerrar modal con ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeDeleteUserModal();
  }
});
</script>

{% endblock %}
