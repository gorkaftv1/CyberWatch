{% extends "base.html" %}

{% block title %}{{ incident.code }} - Detalle{% endblock %}
{% block body_class %}dash-page{% endblock %}

{% block content %}
<div class="dash-layout">
  <aside class="dash-sidebar">
    <div class="dash-sidebar-header">
      <a href="/dashboard" class="dash-logo-link">
        <div class="dash-logo">
          <img src="/static/images/logo.png" alt="CyberWatch Logo" class="dash-logo-img" onerror="this.style.display='none'">
        </div>
        <div class="dash-brand">
          <span class="dash-brand-title">CyberWatch</span>
          <span class="dash-brand-subtitle">SOC Console</span>
        </div>
      </a>
    </div>

    <nav class="dash-nav">
      <a href="/dashboard" class="dash-nav-item">
        <span class="dash-nav-dot"></span>
        <span>Dashboard</span>
      </a>
      <a href="/incidents" class="dash-nav-item dash-nav-item-active">
        <span class="dash-nav-dot"></span>
        <span>Incidentes</span>
      </a>
      {% if user.role == 'admin' %}
      <a href="/users" class="dash-nav-item">
        <span class="dash-nav-dot"></span>
        <span>Usuarios</span>
      </a>
      {% endif %}
    </nav>

    <div class="dash-sidebar-footer">
      <div class="dash-user">
        <div class="dash-user-avatar">{{ user.full_name[0]|upper }}</div>
        <div class="dash-user-meta">
          <span class="dash-user-name">{{ user.full_name }}</span>
          <span class="dash-user-email">{{ user.email }}</span>
        </div>
      </div>
      <a href="/logout" class="dash-logout-link">Cerrar sesión</a>
    </div>
  </aside>

  <main class="dash-main">
    <header class="detail-header">
      <div class="detail-header-left">
        <a href="/incidents?page={{ return_params.page }}&per_page={{ return_params.per_page }}{% if return_params.severity %}&severity={{ return_params.severity }}{% endif %}{% if return_params.status %}&status={{ return_params.status }}{% endif %}{% if return_params.source %}&source={{ return_params.source }}{% endif %}{% if return_params.owner %}&owner={{ return_params.owner }}{% endif %}{% if return_params.search %}&search={{ return_params.search }}{% endif %}" class="btn-back">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M12 16L6 10L12 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
        <div>
          <div class="detail-code-row">
            <h1 class="detail-code">{{ incident.code }}</h1>
            <span class="badge-severity badge-severity-{{ incident.severity.lower() }}">{{ incident.severity }}</span>
          </div>
          <p class="detail-title">{{ incident.title }}</p>
        </div>
      </div>
      <div class="detail-header-right">
        <a href="/incidents/{{ incident.id }}/edit?page={{ return_params.page }}&per_page={{ return_params.per_page }}{% if return_params.severity %}&severity={{ return_params.severity }}{% endif %}{% if return_params.status %}&status={{ return_params.status }}{% endif %}{% if return_params.source %}&source={{ return_params.source }}{% endif %}{% if return_params.owner %}&owner={{ return_params.owner }}{% endif %}{% if return_params.search %}&search={{ return_params.search }}{% endif %}" class="btn-secondary">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M11.5 2.5l2 2L6 12H4v-2l7.5-7.5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Editar
        </a>
        <button class="btn-icon">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <circle cx="10" cy="10" r="1.5" fill="currentColor"/>
            <circle cx="10" cy="4" r="1.5" fill="currentColor"/>
            <circle cx="10" cy="16" r="1.5" fill="currentColor"/>
          </svg>
        </button>
        <div class="user-avatar-small">{{ user.full_name[0]|upper }}</div>
      </div>
    </header>

    <div class="detail-container">
      <div class="detail-main">
        <div class="detail-card">
          <div class="detail-section">
            <div class="section-header">
              <div class="section-icon section-icon-blue">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path d="M9 2L2 7V17C2 17.5523 2.44772 18 3 18H7V12H13V18H17C17.5523 18 18 17.5523 18 17V7L11 2H9Z" stroke="currentColor" stroke-width="1.5"/>
                </svg>
              </div>
              <div>
                <h2 class="section-title">Información básica</h2>
                <p class="section-subtitle">Contexto y primer contacto</p>
              </div>
            </div>

            <div class="detail-grid">
              <div class="detail-field">
                <label class="detail-label">Fecha del incidente</label>
                <div class="detail-value">{{ incident.detected_at.strftime('%d/%m/%Y %H:%M') if incident.detected_at else 'N/A' }}</div>
              </div>

              <div class="detail-field">
                <label class="detail-label">Tipo de incidente</label>
                <div class="detail-value">{{ incident.source }}</div>
              </div>

              <div class="detail-field">
                <label class="detail-label">Estado del ciclo</label>
                <div class="detail-value">
                  <span class="status-badge status-{{ incident.status.lower().replace(' ', '-') }}">{{ incident.status }}</span>
                </div>
              </div>

              <div class="detail-field">
                <label class="detail-label">Responsable</label>
                <div class="detail-value">
                  {% if incident.owner %}
                  <div class="owner-inline">
                    <div class="owner-avatar-small">{{ incident.owner[0]|upper }}</div>
                    <span>{{ incident.owner }}</span>
                  </div>
                  {% else %}
                  <span class="text-muted">Sin asignar</span>
                  {% endif %}
                </div>
              </div>

              <div class="detail-field detail-field-full">
                <label class="detail-label">Descripción</label>
                <div class="detail-value detail-description">
                  {{ incident.description if incident.description else 'Sin descripción proporcionada.' }}
                </div>
              </div>

              <div class="detail-field">
                <label class="detail-label">Última actualización</label>
                <div class="detail-value">{{ incident.updated_at.strftime('%d/%m/%Y %H:%M') if incident.updated_at else 'N/A' }}</div>
              </div>

              <div class="detail-field">
                <label class="detail-label">Confirmación automática del reporte</label>
                <div class="detail-value">
                  <span class="badge-auto">Automático hace 3h</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="detail-card">
          <div class="detail-section">
            <div class="section-header">
              <div class="section-icon section-icon-orange">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path d="M4 4h12M4 8h12M4 12h8M4 16h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </div>
              <div>
                <h2 class="section-title">Logs del Incidente</h2>
                <p class="section-subtitle">Archivos de log adjuntos para análisis</p>
              </div>
            </div>

            {% if attachments %}
            <div class="evidence-list">
              {% for attachment in attachments %}
              <div class="evidence-item">
                <div class="evidence-icon evidence-icon-pdf">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M12 2H5C4.44772 2 4 2.44772 4 3V17C4 17.5523 4.44772 18 5 18H15C15.5523 18 16 17.5523 16 17V6L12 2Z" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M12 2V6H16" stroke="currentColor" stroke-width="1.5"/>
                  </svg>
                </div>
                <div class="evidence-info">
                  <div class="evidence-name">{{ attachment.filename }}</div>
                  <div class="evidence-meta">
                    {{ (attachment.content|length / 1024)|round(1) }} KB · 
                    {{ attachment.content.count('\n') + 1 }} líneas · 
                    Subido el {{ attachment.uploaded_at.strftime('%d/%m/%Y %H:%M') }}
                  </div>
                </div>
                <div class="evidence-actions">
                  <button class="btn-evidence-action" title="Ver contenido" onclick="toggleLogContent({{ attachment.id }})">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M1 8C1 8 3.5 3 8 3C12.5 3 15 8 15 8C15 8 12.5 13 8 13C3.5 13 1 8 1 8Z" stroke="currentColor" stroke-width="1.5"/>
                      <circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                  </button>
                  <button class="btn-evidence-action" title="Eliminar log" onclick="showDeleteLogModal({{ attachment.id }}, '{{ attachment.filename }}', {{ incident.id }})">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M3 4H13M5 4V3C5 2.44772 5.44772 2 6 2H10C10.5523 2 11 2.44772 11 3V4M6.5 7.5V11.5M9.5 7.5V11.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                  </button>
                </div>
              </div>
              <div id="log-content-{{ attachment.id }}" class="log-content" style="display: none;">
                <pre>{{ attachment.content }}</pre>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="evidence-empty" style="text-align: center; padding: 3rem 1rem; color: #64748b;">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="margin: 0 auto 1rem; opacity: 0.5;">
                <path d="M9 12h6M9 16h6M9 8h6M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <p style="font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem;">Todavía no se han adjuntado logs</p>
              <span style="font-size: 0.9rem;">Los archivos de log se pueden adjuntar desde el formulario de edición del incidente.</span>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <aside class="detail-sidebar">
        <div class="sidebar-card">
          <div class="sidebar-card-header">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="1.5"/>
              <path d="M10 6V10L13 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            <h3>Timeline de acciones</h3>
          </div>
          <div class="timeline">
            <div class="timeline-item">
              <div class="timeline-dot timeline-dot-blue"></div>
              <div class="timeline-content">
                <div class="timeline-title">Incidente creado</div>
                <div class="timeline-time">{{ incident.detected_at.strftime('%d/%m/%Y %H:%M') if incident.detected_at else 'N/A' }}</div>
              </div>
            </div>
            <div class="timeline-item">
              <div class="timeline-dot timeline-dot-orange"></div>
              <div class="timeline-content">
                <div class="timeline-title">Asignado a {{ incident.owner if incident.owner else 'Sin asignar' }}</div>
                <div class="timeline-time">{{ incident.detected_at.strftime('%d/%m/%Y %H:%M') if incident.detected_at else 'N/A' }}</div>
              </div>
            </div>
            <div class="timeline-item">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="timeline-title">Última actualización</div>
                <div class="timeline-time">{{ incident.updated_at.strftime('%d/%m/%Y %H:%M') if incident.updated_at else 'N/A' }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="sidebar-card">
          <div class="sidebar-card-header">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M10 2C6 2 3 5 3 9c0 5 7 11 7 11s7-6 7-11c0-4-3-7-7-7z" stroke="currentColor" stroke-width="1.5"/>
              <circle cx="10" cy="9" r="2" stroke="currentColor" stroke-width="1.5"/>
            </svg>
            <h3>Metadatos del incidente</h3>
          </div>
          <div class="metadata-list">
            <div class="metadata-item">
              <span class="metadata-label">ID:</span>
              <span class="metadata-value">{{ incident.id }}</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Código:</span>
              <span class="metadata-value">{{ incident.code }}</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Origen:</span>
              <span class="metadata-value">{{ incident.source }}</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Severidad:</span>
              <span class="metadata-value">{{ incident.severity }}</span>
            </div>
          </div>
        </div>

        <div class="sidebar-card">
          <div class="sidebar-card-header">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M10 2v16M2 10h16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            <h3>Acciones rápidas</h3>
          </div>
          <div class="quick-actions">
            <a href="/incidents/{{ incident.id }}/edit" class="quick-action-btn">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M11.5 2.5l2 2L6 12H4v-2l7.5-7.5z" stroke="currentColor" stroke-width="1.5"/>
              </svg>
              Editar incidente
            </a>
          </div>
        </div>
      </aside>
    </div>
  </main>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Modal Eliminar Log -->
<div id="deleteLogModal" class="modal-overlay" style="display: none;">
  <div class="modal-container">
    <div class="modal-header">
      <div class="modal-icon modal-icon-danger">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M3 6h18M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2m3 0v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6h14z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <h3 class="modal-title">Eliminar Log</h3>
    </div>
    <div class="modal-body">
      <p>¿Estás seguro de que deseas eliminar este log?</p>
      <div class="modal-warning-box">
        <strong id="deleteLogFilename"></strong>
        <span>Esta acción no se puede deshacer.</span>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" onclick="closeDeleteLogModal()">Cancelar</button>
      <form id="deleteLogForm" method="POST" style="display: inline;">
        <button type="submit" class="btn-danger">Sí, eliminar</button>
      </form>
    </div>
  </div>
</div>

<script>
function toggleLogContent(attachmentId) {
  const logContent = document.getElementById('log-content-' + attachmentId);
  if (logContent.style.display === 'none') {
    logContent.style.display = 'block';
  } else {
    logContent.style.display = 'none';
  }
}

function showDeleteLogModal(attachmentId, filename, incidentId) {
  const modal = document.getElementById('deleteLogModal');
  const form = document.getElementById('deleteLogForm');
  const filenameElement = document.getElementById('deleteLogFilename');
  
  filenameElement.textContent = filename;
  form.action = '/incidents/' + incidentId + '/attachments/' + attachmentId + '/delete';
  
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeDeleteLogModal() {
  const modal = document.getElementById('deleteLogModal');
  modal.style.display = 'none';
  document.body.style.overflow = 'auto';
}

// Cerrar modal con ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeDeleteLogModal();
  }
});

// Sistema de Toast
function showToast(message, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast toast-' + type;
  
  const icon = type === 'success' 
    ? '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
    : '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 6v4m0 4h.01M19 10a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
  
  toast.innerHTML = `
    <div class="toast-icon">${icon}</div>
    <div class="toast-message">${message}</div>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('toast-show');
  }, 10);
  
  setTimeout(() => {
    toast.classList.remove('toast-show');
    setTimeout(() => {
      container.removeChild(toast);
    }, 300);
  }, 3000);
}

// Mostrar toast si hay mensaje en la URL
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has('success')) {
  showToast(urlParams.get('success'), 'success');
  // Limpiar URL sin recargar
  window.history.replaceState({}, document.title, window.location.pathname);
}
if (urlParams.has('error')) {
  showToast(urlParams.get('error'), 'error');
  window.history.replaceState({}, document.title, window.location.pathname);
}
</script>
{% endblock %}
